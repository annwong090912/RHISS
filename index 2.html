
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHISS Monthly Absence Dashboard</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            main { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .rounded-2xl, .rounded-3xl { border-radius: 0 !important; box-shadow: none !important; border: none !important; }
            table { width: 100% !important; border: 1px solid #eee !important; }
            th, td { padding: 8px !important; border-bottom: 1px solid #eee !important; font-size: 10pt !important; }
            .bg-emerald-50, .bg-slate-50 { background-color: white !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1mTPiDFbp5Zg-5FdiWkb0srlTPVRmdsb4Kuv-UcScR38/gviz/tq?tqx=out:json';

        const MONTHS = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        const App = () => {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Filters
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch(SHEET_URL);
                        const text = await response.text();
                        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/);
                        if (!match) throw new Error('Invalid Data Format');

                        const json = JSON.parse(match[1]);
                        const rows = json.table.rows.map(row => {
                            const cells = row.c;
                            const dateStr = cells[3]?.f || cells[3]?.v || '';
                            const dateObj = new Date(dateStr);
                            
                            return {
                                studentName: cells[1]?.v || 'Unknown',
                                className: cells[2]?.v || 'N/A',
                                dateFrom: dateStr,
                                dateTo: cells[4]?.f || cells[4]?.v || '',
                                reason: cells[5]?.v || 'No reason',
                                numberOfDays: Number(cells[7]?.v) || 0,
                                month: isNaN(dateObj.getTime()) ? null : dateObj.getMonth(),
                                year: isNaN(dateObj.getTime()) ? null : dateObj.getFullYear()
                            };
                        });
                        setRawData(rows);
                        
                        // Set initial filters to the most recent data if current month is empty
                        const years = [...new Set(rows.map(r => r.year).filter(y => y !== null))].sort((a,b) => b-a);
                        if (years.length > 0) {
                            setSelectedYear(years[0]);
                        }
                    } catch (err) {
                        setError('Failed to load data. Ensure the Google Sheet is shared correctly.');
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            const availableYears = useMemo(() => {
                return [...new Set(rawData.map(r => r.year).filter(y => y !== null))].sort((a,b) => b-a);
            }, [rawData]);

            // Filter data by Month and Year
            const monthlyFilteredData = useMemo(() => {
                return rawData.filter(item => 
                    item.month === selectedMonth && 
                    item.year === selectedYear
                );
            }, [rawData, selectedMonth, selectedYear]);

            // Filter the monthly data by search term
            const finalFilteredData = useMemo(() => {
                return monthlyFilteredData.filter(item => 
                    item.studentName.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [monthlyFilteredData, searchTerm]);

            const stats = useMemo(() => {
                const studentMap = new Map();
                const classMap = new Map();

                monthlyFilteredData.forEach(item => {
                    // Student Ranking for the month
                    const s = studentMap.get(item.studentName) || { name: item.studentName, days: 0, class: item.className };
                    s.days += item.numberOfDays;
                    studentMap.set(item.studentName, s);

                    // Class Ranking for the month
                    if (!classMap.has(item.className)) classMap.set(item.className, new Set());
                    classMap.get(item.className).add(item.studentName);
                });

                return {
                    uniqueStudents: studentMap.size,
                    topStudents: Array.from(studentMap.values()).sort((a,b) => b.days - a.days).slice(0, 3),
                    topClasses: Array.from(classMap.entries())
                        .map(([name, set]) => ({ name, count: set.size }))
                        .sort((a,b) => b.count - a.count).slice(0, 3)
                };
            }, [monthlyFilteredData]);

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-emerald-950">
                    <div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-amber-500 font-bold tracking-widest uppercase">Initializing Dashboard...</p>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900">
                    {/* Header */}
                    <header className="bg-emerald-900 border-b-4 border-amber-500 text-white py-8 px-6 no-print shadow-xl">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
                            <div className="text-center md:text-left">
                                <h1 className="text-4xl font-extrabold text-amber-500">RHISS</h1>
                                <h2 className="text-xl font-light text-emerald-100 tracking-[0.15em] uppercase">Monthly Absence Dashboard</h2>
                            </div>
                            <div className="flex gap-4">
                                <button 
                                    onClick={() => window.print()}
                                    className="bg-amber-500 hover:bg-amber-600 text-emerald-950 font-bold px-6 py-2.5 rounded-xl transition-all flex items-center gap-2 shadow-lg"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    Print Report
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        
                        {/* Monthly Filter Controls */}
                        <div className="mb-8 no-print bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-wrap items-center gap-4">
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Select Year</label>
                                <select 
                                    value={selectedYear} 
                                    onChange={(e) => setSelectedYear(Number(e.target.value))}
                                    className="bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-2 font-bold text-slate-700 outline-none focus:border-amber-500 transition-all"
                                >
                                    {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Select Month</label>
                                <div className="flex flex-wrap gap-2">
                                    {MONTHS.map((m, i) => (
                                        <button 
                                            key={m}
                                            onClick={() => setSelectedMonth(i)}
                                            className={`px-4 py-2 rounded-xl text-sm font-bold transition-all ${selectedMonth === i ? 'bg-emerald-900 text-amber-500 shadow-md transform scale-105' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}
                                        >
                                            {m}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Stats Summary - Monthly Specific */}
                        <section className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 no-print">
                            <div className="bg-white p-6 rounded-2xl border-t-4 border-emerald-600 shadow-sm relative overflow-hidden group">
                                <div className="absolute -right-4 -bottom-4 opacity-5 group-hover:scale-110 transition-transform">
                                    <svg className="w-32 h-32" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" /></svg>
                                </div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">{MONTHS[selectedMonth]} Absences</p>
                                <div className="text-4xl font-black text-emerald-900">{stats.uniqueStudents}</div>
                                <p className="text-xs text-slate-400 mt-2 italic">Individual students absent this month</p>
                            </div>

                            <div className="bg-white p-6 rounded-2xl border-t-4 border-amber-500 shadow-sm">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Highest Absence Frequency</p>
                                <div className="space-y-3">
                                    {stats.topStudents.length > 0 ? stats.topStudents.map((s, i) => (
                                        <div key={i} className="flex justify-between items-center text-sm">
                                            <span className="font-bold text-slate-700 truncate mr-2">{i+1}. {s.name}</span>
                                            <span className="text-amber-600 font-black whitespace-nowrap">{s.days} Days</span>
                                        </div>
                                    )) : <p className="text-xs text-slate-300 italic">No data for this month</p>}
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-2xl border-t-4 border-emerald-900 shadow-sm">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Class Impact Ranking</p>
                                <div className="space-y-3">
                                    {stats.topClasses.length > 0 ? stats.topClasses.map((c, i) => (
                                        <div key={i} className="flex justify-between items-center text-sm">
                                            <span className="font-bold text-slate-700">{i+1}. {c.name}</span>
                                            <span className="text-emerald-800 font-black">{c.count} Students</span>
                                        </div>
                                    )) : <p className="text-xs text-slate-300 italic">No data for this month</p>}
                                </div>
                            </div>
                        </section>

                        {/* Search & Table */}
                        <div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                            <div className="hidden print-only p-8 border-b-2 border-slate-200">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h1 className="text-3xl font-black text-emerald-900 uppercase tracking-tight">RHISS Monthly Report</h1>
                                        <p className="text-lg font-bold text-amber-600">{MONTHS[selectedMonth]} {selectedYear}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xs text-slate-400">Total Unique Students: {stats.uniqueStudents}</p>
                                        <p className="text-xs text-slate-400">Report Date: {new Date().toLocaleDateString()}</p>
                                    </div>
                                </div>
                                {searchTerm && <p className="text-sm mt-4 text-emerald-700 italic border-l-4 border-amber-500 pl-3">Filter Applied: "{searchTerm}"</p>}
                            </div>

                            <div className="p-5 bg-slate-50 no-print flex flex-col sm:flex-row gap-4 items-center border-b border-slate-100">
                                <div className="relative w-full sm:w-96">
                                    <input 
                                        type="text" 
                                        placeholder="Filter results by student name..." 
                                        className="w-full pl-12 pr-4 py-3.5 rounded-2xl border-2 border-slate-200 focus:border-amber-500 outline-none transition-all shadow-sm bg-white"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <svg className="w-5 h-5 absolute left-4 top-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </div>
                                <div className="text-slate-400 font-bold text-sm">
                                    Displaying <span className="text-emerald-600">{finalFilteredData.length}</span> records for <span className="text-amber-600">{MONTHS[selectedMonth]}</span>
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="bg-slate-50 border-b border-slate-200">
                                            <th className="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Name</th>
                                            <th className="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Class</th>
                                            <th className="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Start Date</th>
                                            <th className="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">End Date</th>
                                            <th className="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Reason</th>
                                            <th className="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest text-right">Days</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {finalFilteredData.length > 0 ? finalFilteredData.map((row, i) => (
                                            <tr key={i} className="hover:bg-slate-50/50 transition-colors group">
                                                <td className="px-8 py-5 font-bold text-slate-800">{row.studentName}</td>
                                                <td className="px-8 py-5 text-slate-600 font-medium">{row.className}</td>
                                                <td className="px-8 py-5 text-slate-500 text-sm">{row.dateFrom}</td>
                                                <td className="px-8 py-5 text-slate-500 text-sm">{row.dateTo}</td>
                                                <td className="px-8 py-5 text-slate-500 italic text-sm max-w-xs truncate" title={row.reason}>{row.reason}</td>
                                                <td className="px-8 py-5 text-right font-black text-emerald-800 text-lg">{row.numberOfDays}</td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan={6} className="px-8 py-20 text-center">
                                                    <div className="text-slate-300 font-bold text-xl mb-2">No Records Found</div>
                                                    <p className="text-slate-400 text-sm">Try selecting a different month or clearing your search.</p>
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="hidden print-only p-8 text-center text-[8pt] text-slate-300 border-t border-slate-100 italic">
                                This is an official electronic record generated by the RHISS Absence Monitoring System. 
                                &copy; {selectedYear} RHISS Administration
                            </div>
                        </div>
                    </main>
                    
                    {error && (
                        <div className="fixed bottom-4 right-4 bg-red-600 text-white p-5 rounded-2xl shadow-2xl flex items-center gap-3 animate-bounce">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            <span className="font-bold">{error}</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
