
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHISS Monthly Absence Dashboard</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            main { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .rounded-2xl, .rounded-3xl { border-radius: 0 !important; box-shadow: none !important; border: none !important; }
            table { width: 100% !important; border: 1px solid #eee !important; border-collapse: collapse; }
            th, td { padding: 8px !important; border-bottom: 1px solid #eee !important; font-size: 10pt !important; }
            .bg-emerald-50, .bg-slate-50, .bg-emerald-900 { background-color: white !important; color: black !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1mTPiDFbp5Zg-5FdiWkb0srlTPVRmdsb4Kuv-UcScR38/gviz/tq?tqx=out:json';

        const MONTHS = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        // Helper to parse Google Sheets Date strings like "Date(2024,1,15)"
        const parseGoogleDate = (dateStr) => {
            if (!dateStr) return null;
            if (dateStr.includes('Date(')) {
                const parts = dateStr.match(/\d+/g);
                if (parts && parts.length >= 3) {
                    // Google Sheets months are 0-indexed in the Date() string
                    return new Date(parts[0], parts[1], parts[2]);
                }
            }
            const standard = new Date(dateStr);
            return isNaN(standard.getTime()) ? null : standard;
        };

        const App = () => {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch(SHEET_URL);
                        const text = await response.text();
                        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/);
                        if (!match) throw new Error('Invalid Data Format');

                        const json = JSON.parse(match[1]);
                        const rows = json.table.rows.map(row => {
                            const cells = row.c;
                            const dateFromRaw = cells[3]?.v || '';
                            const dateObj = parseGoogleDate(dateFromRaw);
                            
                            return {
                                studentName: cells[1]?.v || 'Unknown',
                                className: cells[2]?.v || 'N/A',
                                dateFromFormatted: cells[3]?.f || dateObj?.toLocaleDateString() || '',
                                dateToFormatted: cells[4]?.f || '',
                                reason: cells[5]?.v || 'No reason provided',
                                numberOfDays: Number(cells[7]?.v) || 0,
                                month: dateObj ? dateObj.getMonth() : null,
                                year: dateObj ? dateObj.getFullYear() : null
                            };
                        });
                        setRawData(rows);
                        
                        // Set initial filter to latest year available
                        const years = [...new Set(rows.map(r => r.year).filter(y => y !== null))].sort((a,b) => b-a);
                        if (years.length > 0 && !years.includes(selectedYear)) {
                            setSelectedYear(years[0]);
                        }
                    } catch (err) {
                        setError('Connection Error: Please check your internet or ensure the Google Sheet is shared publically.');
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            const availableYears = useMemo(() => {
                return [...new Set(rawData.map(r => r.year).filter(y => y !== null))].sort((a,b) => b-a);
            }, [rawData]);

            const monthlyFilteredData = useMemo(() => {
                return rawData.filter(item => 
                    item.month === selectedMonth && 
                    item.year === selectedYear
                );
            }, [rawData, selectedMonth, selectedYear]);

            const finalFilteredData = useMemo(() => {
                return monthlyFilteredData.filter(item => 
                    item.studentName.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [monthlyFilteredData, searchTerm]);

            const stats = useMemo(() => {
                const studentMap = new Map();
                const classMap = new Map();

                monthlyFilteredData.forEach(item => {
                    const s = studentMap.get(item.studentName) || { name: item.studentName, days: 0, class: item.className };
                    s.days += item.numberOfDays;
                    studentMap.set(item.studentName, s);

                    if (!classMap.has(item.className)) classMap.set(item.className, new Set());
                    classMap.get(item.className).add(item.studentName);
                });

                return {
                    uniqueStudents: studentMap.size,
                    topStudents: Array.from(studentMap.values()).sort((a,b) => b.days - a.days).slice(0, 3),
                    topClasses: Array.from(classMap.entries())
                        .map(([name, set]) => ({ name, count: set.size }))
                        .sort((a,b) => b.count - a.count).slice(0, 3)
                };
            }, [monthlyFilteredData]);

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-emerald-950">
                    <div className="w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-6"></div>
                    <p className="text-amber-500 font-bold tracking-[0.3em] uppercase animate-pulse">Synchronizing Dashboard</p>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900">
                    {/* Header */}
                    <header className="bg-emerald-900 border-b-4 border-amber-500 text-white py-10 px-6 no-print shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-amber-500/10 -mr-20 -mt-20 rounded-full blur-3xl"></div>
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 relative z-10">
                            <div className="text-center md:text-left">
                                <h1 className="text-5xl font-black text-amber-500 tracking-tighter">RHISS</h1>
                                <h2 className="text-xl font-medium text-emerald-100/80 tracking-[0.2em] uppercase mt-1">Absence Statistics</h2>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="hidden lg:block text-right mr-4 border-r border-emerald-700 pr-6">
                                    <p className="text-[10px] text-emerald-300 uppercase tracking-widest font-bold">System Status</p>
                                    <p className="text-sm font-bold text-white flex items-center justify-end gap-2">
                                        <span className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                                        Live Database Linked
                                    </p>
                                </div>
                                <button 
                                    onClick={() => window.print()}
                                    className="bg-amber-500 hover:bg-amber-600 text-emerald-950 font-black px-8 py-3.5 rounded-2xl transition-all flex items-center gap-2 shadow-[0_10px_20px_-5px_rgba(245,158,11,0.4)] hover:-translate-y-1 active:scale-95"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                    Generate Report
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        
                        {/* Filters Panel */}
                        <div className="mb-10 no-print bg-white p-8 rounded-3xl shadow-sm border border-slate-200 flex flex-col xl:flex-row items-start xl:items-center gap-8">
                            <div className="flex flex-col gap-2 min-w-[140px]">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">Academic Year</label>
                                <select 
                                    value={selectedYear} 
                                    onChange={(e) => setSelectedYear(Number(e.target.value))}
                                    className="bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-3 font-bold text-slate-700 outline-none focus:border-amber-500 transition-all appearance-none cursor-pointer"
                                >
                                    {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                                    {availableYears.length === 0 && <option value={new Date().getFullYear()}>{new Date().getFullYear()}</option>}
                                </select>
                            </div>
                            
                            <div className="flex-1 flex flex-col gap-2 w-full">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">Monthly Selection</label>
                                <div className="flex flex-wrap gap-2">
                                    {MONTHS.map((m, i) => (
                                        <button 
                                            key={m}
                                            onClick={() => setSelectedMonth(i)}
                                            className={`px-5 py-2.5 rounded-xl text-xs font-black transition-all border-2 ${selectedMonth === i ? 'bg-emerald-900 text-amber-500 border-emerald-900 shadow-lg scale-105 z-10' : 'bg-white text-slate-400 border-slate-100 hover:border-slate-300 hover:text-slate-600'}`}
                                        >
                                            {m}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Summary Cards */}
                        <section className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 no-print">
                            <div className="bg-white p-8 rounded-3xl border-t-8 border-emerald-600 shadow-sm relative overflow-hidden group">
                                <div className="absolute -right-6 -bottom-6 opacity-5 group-hover:scale-110 transition-transform">
                                    <svg className="w-40 h-40" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" /></svg>
                                </div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">{MONTHS[selectedMonth]} Volume</p>
                                <div className="text-5xl font-black text-emerald-950 tracking-tight">{stats.uniqueStudents}</div>
                                <div className="mt-4 flex items-center gap-2 text-emerald-600 font-bold text-xs bg-emerald-50 w-fit px-3 py-1 rounded-full">
                                    Total Students Absent
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-3xl border-t-8 border-amber-500 shadow-sm">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Top Student Absences</p>
                                <div className="space-y-4">
                                    {stats.topStudents.length > 0 ? stats.topStudents.map((s, i) => (
                                        <div key={i} className="flex justify-between items-center group">
                                            <div className="flex items-center gap-3">
                                                <span className="w-6 h-6 rounded-lg bg-amber-100 text-amber-700 flex items-center justify-center text-[10px] font-black">{i+1}</span>
                                                <span className="font-bold text-slate-700 truncate max-w-[120px]">{s.name}</span>
                                            </div>
                                            <span className="text-amber-600 font-black text-sm whitespace-nowrap bg-amber-50 px-3 py-1 rounded-lg">{s.days} Days</span>
                                        </div>
                                    )) : <p className="text-sm text-slate-300 italic py-4">No records found this month.</p>}
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-3xl border-t-8 border-emerald-950 shadow-sm">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Class Impact Ranking</p>
                                <div className="space-y-4">
                                    {stats.topClasses.length > 0 ? stats.topClasses.map((c, i) => (
                                        <div key={i} className="flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                <span className="w-6 h-6 rounded-lg bg-emerald-100 text-emerald-700 flex items-center justify-center text-[10px] font-black">{i+1}</span>
                                                <span className="font-bold text-slate-700">{c.name}</span>
                                            </div>
                                            <span className="text-emerald-900 font-black text-sm bg-emerald-50 px-3 py-1 rounded-lg">{c.count} Students</span>
                                        </div>
                                    )) : <p className="text-sm text-slate-300 italic py-4">No data available.</p>}
                                </div>
                            </div>
                        </section>

                        {/* Main Data Container */}
                        <div className="bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 overflow-hidden">
                            {/* Print Header */}
                            <div className="hidden print-only p-12 border-b-4 border-emerald-900">
                                <div className="flex justify-between items-end">
                                    <div>
                                        <h1 className="text-4xl font-black text-emerald-900 tracking-tighter uppercase">RHISS Academic Report</h1>
                                        <p className="text-xl font-bold text-amber-600 mt-2">Absence Summary: {MONTHS[selectedMonth]} {selectedYear}</p>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-sm font-bold text-slate-400 uppercase tracking-widest">Total Absences</div>
                                        <div className="text-4xl font-black text-emerald-900">{monthlyFilteredData.length}</div>
                                    </div>
                                </div>
                                <div className="mt-8 grid grid-cols-2 gap-4 text-sm bg-slate-50 p-6 rounded-2xl">
                                    <div><span className="font-bold text-slate-400">REPORT GENERATED:</span> {new Date().toLocaleDateString()}</div>
                                    <div className="text-right"><span className="font-bold text-slate-400">UNIQUE STUDENTS:</span> {stats.uniqueStudents}</div>
                                </div>
                            </div>

                            {/* Search Bar - No Print */}
                            <div className="p-8 bg-slate-50 no-print flex flex-col sm:flex-row gap-6 items-center border-b border-slate-100">
                                <div className="relative w-full sm:w-[450px]">
                                    <input 
                                        type="text" 
                                        placeholder="Quick filter by student name..." 
                                        className="w-full pl-14 pr-6 py-4 rounded-[1.25rem] border-2 border-slate-200 focus:border-amber-500 outline-none transition-all shadow-sm bg-white font-medium text-slate-700"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <svg className="w-6 h-6 absolute left-5 top-4.5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="text-slate-300 font-bold text-xs uppercase tracking-widest">Showing</span>
                                    <span className="bg-emerald-900 text-amber-500 font-black px-4 py-1.5 rounded-full text-sm shadow-lg">
                                        {finalFilteredData.length} Records
                                    </span>
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="bg-slate-50/50 border-b border-slate-200">
                                            <th className="px-10 py-6 text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Full Name</th>
                                            <th className="px-10 py-6 text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Class</th>
                                            <th className="px-10 py-6 text-xs font-black text-slate-400 uppercase tracking-[0.2em]">From</th>
                                            <th className="px-10 py-6 text-xs font-black text-slate-400 uppercase tracking-[0.2em]">To</th>
                                            <th className="px-10 py-6 text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Reason for Absence</th>
                                            <th className="px-10 py-6 text-xs font-black text-slate-400 uppercase tracking-[0.2em] text-right">Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {finalFilteredData.length > 0 ? finalFilteredData.map((row, i) => (
                                            <tr key={i} className="hover:bg-slate-50/80 transition-all group cursor-default">
                                                <td className="px-10 py-6">
                                                    <div className="font-extrabold text-slate-900 group-hover:text-emerald-900 transition-colors">{row.studentName}</div>
                                                </td>
                                                <td className="px-10 py-6 font-bold text-slate-500">{row.className}</td>
                                                <td className="px-10 py-6 text-slate-500 text-sm font-medium">{row.dateFromFormatted}</td>
                                                <td className="px-10 py-6 text-slate-500 text-sm font-medium">{row.dateToFormatted}</td>
                                                <td className="px-10 py-6">
                                                    <div className="text-slate-500 italic text-sm max-w-sm leading-relaxed" title={row.reason}>
                                                        {row.reason}
                                                    </div>
                                                </td>
                                                <td className="px-10 py-6 text-right">
                                                    <span className="inline-block bg-emerald-50 text-emerald-800 font-black text-lg px-4 py-1 rounded-xl group-hover:bg-emerald-900 group-hover:text-amber-500 transition-all">
                                                        {row.numberOfDays}
                                                    </span>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan={6} className="px-10 py-32 text-center">
                                                    <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                                        <svg className="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                                                    </div>
                                                    <h3 className="text-2xl font-black text-slate-300 uppercase tracking-widest">No Data Logged</h3>
                                                    <p className="text-slate-400 mt-2 font-medium">There are no records found for {MONTHS[selectedMonth]} {selectedYear}.</p>
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="hidden print-only p-12 text-center border-t-2 border-slate-100 italic text-slate-300 text-xs">
                                RHISS Official Student Records Dashboard &bull; Confirmed &bull; {new Date().getFullYear()}
                            </div>
                        </div>
                    </main>
                    
                    {error && (
                        <div className="fixed bottom-8 right-8 bg-red-600 text-white p-6 rounded-[2rem] shadow-[0_20px_50px_rgba(220,38,38,0.3)] flex items-center gap-4 animate-bounce z-50">
                            <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            </div>
                            <span className="font-black text-sm tracking-tight">{error}</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
