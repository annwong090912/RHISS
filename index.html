
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHISS Student Absence Statistics</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            main { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .rounded-2xl, .rounded-3xl, .rounded-\[2\.5rem\] { border-radius: 0 !important; box-shadow: none !important; border: none !important; }
            table { width: 100% !important; border: 1px solid #eee !important; border-collapse: collapse; }
            th, td { padding: 10px !important; border-bottom: 1px solid #eee !important; font-size: 9pt !important; }
            .bg-emerald-50, .bg-slate-50, .bg-emerald-900 { background-color: white !important; color: black !important; }
            .text-amber-500, .text-amber-600 { color: #854d0e !important; } /* Darker amber for print legibility */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1mTPiDFbp5Zg-5FdiWkb0srlTPVRmdsb4Kuv-UcScR38/gviz/tq?tqx=out:json';

        const MONTHS = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        // Helper to parse Google Sheets Date strings like "Date(2024,1,15)"
        const parseGoogleDate = (dateStr) => {
            if (!dateStr) return null;
            if (typeof dateStr === 'string' && dateStr.includes('Date(')) {
                const parts = dateStr.match(/\d+/g);
                if (parts && parts.length >= 3) {
                    // Month is 0-indexed in GSheet JSON
                    return new Date(parts[0], parts[1], parts[2]);
                }
            }
            const standard = new Date(dateStr);
            return isNaN(standard.getTime()) ? null : standard;
        };

        const App = () => {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Filters
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [selectedClass, setSelectedClass] = useState('All');
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch(SHEET_URL);
                        const text = await response.text();
                        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/);
                        if (!match) throw new Error('Format Error');

                        const json = JSON.parse(match[1]);
                        const rows = json.table.rows.map(row => {
                            const cells = row.c;
                            // mapping columns based on user requirement (assuming Col A is timestamp if from Google Form)
                            const dateFromRaw = cells[3]?.v || '';
                            const dateObj = parseGoogleDate(dateFromRaw);
                            
                            return {
                                studentName: cells[1]?.v || 'Unknown',
                                className: cells[2]?.v || 'N/A',
                                dateFromFormatted: cells[3]?.f || dateObj?.toLocaleDateString() || 'N/A',
                                dateToFormatted: cells[4]?.f || cells[4]?.v || 'N/A',
                                reason: cells[5]?.v || 'None',
                                numberOfDays: Number(cells[6]?.v) || Number(cells[7]?.v) || 0, // Fallback check for G vs H column
                                month: dateObj ? dateObj.getMonth() : null,
                                year: dateObj ? dateObj.getFullYear() : null
                            };
                        });
                        setRawData(rows);
                        
                        // Default to latest year in data
                        const years = [...new Set(rows.map(r => r.year).filter(y => y !== null))].sort((a,b) => b-a);
                        if (years.length > 0 && !years.includes(selectedYear)) {
                            setSelectedYear(years[0]);
                        }
                    } catch (err) {
                        setError('Failed to fetch data. Check your Google Sheet visibility.');
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            const availableYears = useMemo(() => {
                return [...new Set(rawData.map(r => r.year).filter(y => y !== null))].sort((a,b) => b-a);
            }, [rawData]);

            const monthlyBaseData = useMemo(() => {
                return rawData.filter(item => 
                    item.month === selectedMonth && 
                    item.year === selectedYear
                );
            }, [rawData, selectedMonth, selectedYear]);

            const availableClasses = useMemo(() => {
                const classes = [...new Set(monthlyBaseData.map(item => item.className))].sort();
                return ['All', ...classes];
            }, [monthlyBaseData]);

            const finalFilteredData = useMemo(() => {
                return monthlyBaseData.filter(item => {
                    const matchesClass = selectedClass === 'All' || item.className === selectedClass;
                    const matchesSearch = item.studentName.toLowerCase().includes(searchTerm.toLowerCase());
                    return matchesClass && matchesSearch;
                });
            }, [monthlyBaseData, selectedClass, searchTerm]);

            const stats = useMemo(() => {
                const studentMap = new Map();
                const classMap = new Map();

                const statsSource = selectedClass === 'All' ? monthlyBaseData : monthlyBaseData.filter(i => i.className === selectedClass);

                statsSource.forEach(item => {
                    // Student aggregation
                    const s = studentMap.get(item.studentName) || { name: item.studentName, days: 0, class: item.className };
                    s.days += item.numberOfDays;
                    studentMap.set(item.studentName, s);

                    // Class aggregation
                    if (!classMap.has(item.className)) classMap.set(item.className, new Set());
                    classMap.get(item.className).add(item.studentName);
                });

                return {
                    uniqueStudents: studentMap.size,
                    topStudents: Array.from(studentMap.values()).sort((a,b) => b.days - a.days).slice(0, 3),
                    topClasses: Array.from(classMap.entries())
                        .map(([name, set]) => ({ name, count: set.size }))
                        .sort((a,b) => b.count - a.count).slice(0, 3)
                };
            }, [monthlyBaseData, selectedClass]);

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-emerald-950">
                    <div className="w-14 h-14 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-amber-500 font-bold tracking-widest uppercase animate-pulse">Loading RHISS Statistics...</p>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900">
                    {/* Header */}
                    <header className="bg-emerald-900 border-b-4 border-amber-500 text-white py-12 px-6 no-print shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-80 h-80 bg-amber-500/5 -mr-20 -mt-20 rounded-full blur-[100px]"></div>
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 relative z-10">
                            <div className="text-center md:text-left">
                                <h1 className="text-5xl font-extrabold text-amber-500 tracking-tight">RHISS</h1>
                                <h2 className="text-xl font-medium text-emerald-200 tracking-[0.25em] uppercase mt-2">Student Absence Statistics</h2>
                            </div>
                            <button 
                                onClick={() => window.print()}
                                className="bg-amber-500 hover:bg-amber-600 text-emerald-950 font-black px-10 py-4 rounded-2xl transition-all flex items-center gap-3 shadow-[0_15px_30px_-5px_rgba(245,158,11,0.3)] hover:-translate-y-1 active:scale-95"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                Print Report
                            </button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-10">
                        
                        {/* Filters */}
                        <div className="mb-12 no-print bg-white p-8 rounded-3xl shadow-sm border border-slate-200 grid grid-cols-1 lg:grid-cols-12 gap-8 items-end">
                            <div className="lg:col-span-2 flex flex-col gap-2">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Academic Year</label>
                                <select 
                                    value={selectedYear} 
                                    onChange={(e) => { setSelectedYear(Number(e.target.value)); setSelectedClass('All'); }}
                                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-3 font-bold text-slate-700 focus:border-amber-500 outline-none transition-all cursor-pointer"
                                >
                                    {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                                    {availableYears.length === 0 && <option value={new Date().getFullYear()}>{new Date().getFullYear()}</option>}
                                </select>
                            </div>

                            <div className="lg:col-span-3 flex flex-col gap-2">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Target Class</label>
                                <select 
                                    value={selectedClass} 
                                    onChange={(e) => setSelectedClass(e.target.value)}
                                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-3 font-bold text-slate-700 focus:border-amber-500 outline-none transition-all cursor-pointer"
                                >
                                    {availableClasses.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            
                            <div className="lg:col-span-7 flex flex-col gap-2">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Monthly View</label>
                                <div className="flex flex-wrap gap-2">
                                    {MONTHS.map((m, i) => (
                                        <button 
                                            key={m}
                                            onClick={() => { setSelectedMonth(i); setSelectedClass('All'); }}
                                            className={`px-4 py-2.5 rounded-xl text-[10px] font-black transition-all border-2 ${selectedMonth === i ? 'bg-emerald-900 text-amber-500 border-emerald-900 shadow-lg scale-105 z-10' : 'bg-white text-slate-400 border-slate-100 hover:border-slate-300'}`}
                                        >
                                            {m}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Summary Cards */}
                        <section className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 no-print">
                            <div className="bg-white p-8 rounded-3xl border-t-8 border-emerald-600 shadow-sm group">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">{selectedClass === 'All' ? MONTHS[selectedMonth] : selectedClass}</p>
                                <div className="text-5xl font-black text-emerald-950 tracking-tighter">{stats.uniqueStudents}</div>
                                <p className="mt-4 text-emerald-600 font-bold text-xs bg-emerald-50 w-fit px-4 py-1.5 rounded-full">Individual Absences</p>
                            </div>

                            <div className="bg-white p-8 rounded-3xl border-t-8 border-amber-500 shadow-sm">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Highest Freq (Students)</p>
                                <div className="space-y-4">
                                    {stats.topStudents.length > 0 ? stats.topStudents.map((s, i) => (
                                        <div key={i} className="flex justify-between items-center group">
                                            <div className="flex items-center gap-3">
                                                <span className="w-7 h-7 rounded-lg bg-amber-100 text-amber-700 flex items-center justify-center text-[11px] font-black">{i+1}</span>
                                                <span className="font-bold text-slate-700 truncate max-w-[130px]">{s.name}</span>
                                            </div>
                                            <span className="text-amber-600 font-black text-sm bg-amber-50 px-3 py-1 rounded-lg">{s.days} Days</span>
                                        </div>
                                    )) : <p className="text-sm text-slate-300 italic py-2">No data recorded.</p>}
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-3xl border-t-8 border-emerald-950 shadow-sm">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Highest Freq (Class)</p>
                                <div className="space-y-4">
                                    {stats.topClasses.length > 0 ? stats.topClasses.map((c, i) => (
                                        <div key={i} className="flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                <span className="w-7 h-7 rounded-lg bg-emerald-100 text-emerald-700 flex items-center justify-center text-[11px] font-black">{i+1}</span>
                                                <span className="font-bold text-slate-700">{c.name}</span>
                                            </div>
                                            <span className="text-emerald-900 font-black text-sm bg-emerald-50 px-3 py-1 rounded-lg">{c.count} Students</span>
                                        </div>
                                    )) : <p className="text-sm text-slate-300 italic py-2">No data recorded.</p>}
                                </div>
                            </div>
                        </section>

                        {/* Data Table */}
                        <div className="bg-white rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden">
                            {/* Print Header */}
                            <div className="hidden print-only p-12 border-b-4 border-emerald-900">
                                <div className="flex justify-between items-end">
                                    <div>
                                        <h1 className="text-4xl font-black text-emerald-900 tracking-tighter uppercase">RHISS Academic Record</h1>
                                        <p className="text-xl font-bold text-amber-600 mt-2">Absence Report: {MONTHS[selectedMonth]} {selectedYear}</p>
                                        <p className="text-md font-bold text-slate-500 uppercase tracking-widest mt-1">Class Scope: {selectedClass}</p>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Absence Count</div>
                                        <div className="text-5xl font-black text-emerald-900">{finalFilteredData.length}</div>
                                    </div>
                                </div>
                                <div className="mt-10 grid grid-cols-2 gap-8 text-xs bg-slate-50 p-6 rounded-2xl border border-slate-100">
                                    <div><span className="font-bold text-slate-400 uppercase">Generated On:</span> {new Date().toLocaleString()}</div>
                                    <div className="text-right"><span className="font-bold text-slate-400 uppercase">Unique Impacted Students:</span> {stats.uniqueStudents}</div>
                                </div>
                            </div>

                            {/* Dashboard Search */}
                            <div className="p-8 bg-slate-50 no-print flex flex-col sm:flex-row gap-6 items-center border-b border-slate-200">
                                <div className="relative w-full sm:w-[450px]">
                                    <input 
                                        type="text" 
                                        placeholder="Live search by student name..." 
                                        className="w-full pl-14 pr-6 py-4 rounded-2xl border-2 border-slate-200 focus:border-amber-500 outline-none transition-all shadow-sm font-semibold text-slate-700"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <svg className="w-6 h-6 absolute left-5 top-4.5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </div>
                                <div className="flex flex-wrap items-center gap-3">
                                    <span className="bg-emerald-900 text-amber-500 font-black px-5 py-2 rounded-xl text-xs shadow-md">
                                        {finalFilteredData.length} RECORDS FOUND
                                    </span>
                                    {selectedClass !== 'All' && (
                                        <span className="bg-amber-100 text-amber-800 font-black px-4 py-2 rounded-xl text-[10px] uppercase">
                                            FILTERED: {selectedClass}
                                        </span>
                                    )}
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="bg-slate-50/50 border-b border-slate-200">
                                            <th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Student Name</th>
                                            <th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Class</th>
                                            <th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">From</th>
                                            <th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">To</th>
                                            <th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Reason</th>
                                            <th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] text-right">Days</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {finalFilteredData.length > 0 ? finalFilteredData.map((row, i) => (
                                            <tr key={i} className="hover:bg-slate-50 transition-all group">
                                                <td className="px-10 py-6">
                                                    <div className="font-extrabold text-slate-900 group-hover:text-emerald-900">{row.studentName}</div>
                                                </td>
                                                <td className="px-10 py-6 font-bold text-slate-500 text-sm">{row.className}</td>
                                                <td className="px-10 py-6 text-slate-500 text-sm">{row.dateFromFormatted}</td>
                                                <td className="px-10 py-6 text-slate-500 text-sm">{row.dateToFormatted}</td>
                                                <td className="px-10 py-6">
                                                    <div className="text-slate-400 italic text-sm max-w-[250px] truncate" title={row.reason}>
                                                        {row.reason}
                                                    </div>
                                                </td>
                                                <td className="px-10 py-6 text-right">
                                                    <span className="inline-block bg-emerald-50 text-emerald-800 font-black text-base px-4 py-1.5 rounded-xl group-hover:bg-emerald-900 group-hover:text-amber-500 transition-all">
                                                        {row.numberOfDays}
                                                    </span>
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan={6} className="px-10 py-32 text-center">
                                                    <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-dashed border-slate-200">
                                                        <svg className="w-8 h-8 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                                    </div>
                                                    <p className="text-slate-400 font-bold uppercase tracking-widest">No entries for this period.</p>
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="hidden print-only p-12 text-center border-t-2 border-slate-100 italic text-slate-300 text-[10px]">
                                RHISS Student Absence Monitoring System &bull; Confidential Administrative Document &bull; {selectedYear}
                            </div>
                        </div>
                    </main>
                    
                    {error && (
                        <div className="fixed bottom-10 right-10 bg-red-600 text-white p-6 rounded-3xl shadow-2xl flex items-center gap-4 animate-bounce z-50 border-4 border-white">
                            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            <span className="font-black text-sm">{error}</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
