
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHISS Absence Statistics</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            main { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .rounded-3xl { border-radius: 0 !important; box-shadow: none !important; border: none !important; }
            table { width: 100% !important; border: 1px solid #eee !important; }
            th, td { padding: 8px !important; border-bottom: 1px solid #eee !important; font-size: 10pt !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1mTPiDFbp5Zg-5FdiWkb0srlTPVRmdsb4Kuv-UcScR38/gviz/tq?tqx=out:json';

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch(SHEET_URL);
                        const text = await response.text();
                        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/);
                        if (!match) throw new Error('Invalid Data Format');

                        const json = JSON.parse(match[1]);
                        const rows = json.table.rows.map(row => {
                            const cells = row.c;
                            return {
                                studentName: cells[1]?.v || 'Unknown',
                                className: cells[2]?.v || 'N/A',
                                dateFrom: cells[3]?.f || cells[3]?.v || '',
                                dateTo: cells[4]?.f || cells[4]?.v || '',
                                reason: cells[5]?.v || 'No reason',
                                numberOfDays: Number(cells[7]?.v) || 0
                            };
                        });
                        setData(rows);
                    } catch (err) {
                        setError('Failed to load data. Ensure the Google Sheet is shared with "Anyone with the link".');
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            const filteredData = useMemo(() => {
                return data.filter(item => 
                    item.studentName.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [data, searchTerm]);

            const stats = useMemo(() => {
                const studentMap = new Map();
                const classMap = new Map();

                data.forEach(item => {
                    // Student Ranking
                    const s = studentMap.get(item.studentName) || { name: item.studentName, days: 0, class: item.className };
                    s.days += item.numberOfDays;
                    studentMap.set(item.studentName, s);

                    // Class Ranking
                    if (!classMap.has(item.className)) classMap.set(item.className, new Set());
                    classMap.get(item.className).add(item.studentName);
                });

                return {
                    uniqueStudents: studentMap.size,
                    topStudents: Array.from(studentMap.values()).sort((a,b) => b.days - a.days).slice(0, 3),
                    topClasses: Array.from(classMap.entries())
                        .map(([name, set]) => ({ name, count: set.size }))
                        .sort((a,b) => b.count - a.count).slice(0, 3)
                };
            }, [data]);

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-emerald-950">
                    <div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-amber-500 font-bold tracking-widest uppercase">RHISS Syncing...</p>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900">
                    {/* Header */}
                    <header className="bg-emerald-900 border-b-4 border-amber-500 text-white py-10 px-6 no-print shadow-xl">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
                            <div className="text-center md:text-left">
                                <h1 className="text-4xl font-extrabold text-amber-500">RHISS</h1>
                                <h2 className="text-xl font-light text-emerald-100 tracking-widest uppercase">Student Absence Statistics</h2>
                            </div>
                            <button 
                                onClick={() => window.print()}
                                className="bg-amber-500 hover:bg-amber-600 text-emerald-950 font-bold px-8 py-3 rounded-full transition-all flex items-center gap-2 shadow-lg"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                                Print Report
                            </button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {/* Stats Summary */}
                        <section className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 no-print">
                            <div className="bg-white p-6 rounded-2xl border-t-4 border-emerald-600 shadow-sm">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Unique Students</p>
                                <div className="text-4xl font-black text-emerald-900">{stats.uniqueStudents}</div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl border-t-4 border-amber-500 shadow-sm">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Highest Frequency (Students)</p>
                                <div className="space-y-3">
                                    {stats.topStudents.map((s, i) => (
                                        <div key={i} className="flex justify-between items-center text-sm">
                                            <span className="font-bold text-slate-700">{i+1}. {s.name}</span>
                                            <span className="text-amber-600 font-black">{s.days} Days</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl border-t-4 border-emerald-900 shadow-sm">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Highest Frequency (Classes)</p>
                                <div className="space-y-3">
                                    {stats.topClasses.map((c, i) => (
                                        <div key={i} className="flex justify-between items-center text-sm">
                                            <span className="font-bold text-slate-700">{i+1}. {c.name}</span>
                                            <span className="text-emerald-800 font-black">{c.count} Students</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </section>

                        {/* Search & Table */}
                        <div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                            <div className="hidden print-only p-6 border-b-2 border-slate-200">
                                <h1 className="text-2xl font-bold text-emerald-900">RHISS Absence Report</h1>
                                <p className="text-sm text-slate-500">Date: {new Date().toLocaleDateString()}</p>
                                {searchTerm && <p className="text-sm mt-1 text-amber-600 italic">Filter: "{searchTerm}"</p>}
                            </div>

                            <div className="p-5 bg-emerald-50 no-print flex flex-col sm:flex-row gap-4 items-center">
                                <div className="relative w-full sm:w-80">
                                    <input 
                                        type="text" 
                                        placeholder="Search student name..." 
                                        className="w-full pl-10 pr-4 py-3 rounded-xl border-2 border-slate-200 focus:border-amber-500 outline-none transition-all shadow-sm"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <svg className="w-5 h-5 absolute left-3 top-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </div>
                                <span className="text-emerald-800 font-bold text-sm bg-emerald-100 px-4 py-2 rounded-full">
                                    {filteredData.length} records matching
                                </span>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="bg-slate-50 border-b border-slate-200">
                                            <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">Name</th>
                                            <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">Class</th>
                                            <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">From</th>
                                            <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">To</th>
                                            <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest">Reason</th>
                                            <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest text-right">Days</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {filteredData.map((row, i) => (
                                            <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-6 py-4 font-bold text-slate-900">{row.studentName}</td>
                                                <td className="px-6 py-4 text-slate-600">{row.className}</td>
                                                <td className="px-6 py-4 text-slate-500 text-sm">{row.dateFrom}</td>
                                                <td className="px-6 py-4 text-slate-500 text-sm">{row.dateTo}</td>
                                                <td className="px-6 py-4 text-slate-600 italic text-sm">{row.reason}</td>
                                                <td className="px-6 py-4 text-right font-black text-emerald-800">{row.numberOfDays}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                    
                    {error && (
                        <div className="fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-xl shadow-2xl animate-pulse">
                            {error}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
